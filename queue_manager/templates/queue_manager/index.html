{% extends 'base.html' %}
{% load custom_filters %}

{% block extra_head %}
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #1e2a3a;
            color: white;
            padding: 1rem;
        }
        main {
            padding: 1rem;
            width: 90%;
            margin: auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            padding: 1rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .queue-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        .stat-value {
            color: black;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .join-input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .join-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            display: inline-flex;
        }

            /*new*/
        .button-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-btn {
            background-color: #6c757d;
            color: white;
        }

        .leave-queue-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .card {
            position: relative;
        }
        .d-none {
            display: none;
        }

    </style>
{% endblock %}

{% block content %}
    <main>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="card-title">Current Queues</div>
                <div class="button-group">
                    <button onclick="toggleEditMode()" class="btn edit-btn me-2">Edit</button>
                    <a href="{% url 'queue:history' %}" class="btn join-btn">History</a>
                </div>
            </div>
            {% if queue_list %}
                {% for queue in queue_list %}
                    <div class="card position-relative">
                        <h3>{{ queue.name }}</h3>
                        <div class="queue-stats">
                            <div>
                                <div class="stat-label">Your Position</div>
                                <div class="stat-value">{{ queue_positions|get_item:queue.id }}</div>
                            </div>
                            <div>
                                <div class="stat-label">Queue Length</div>
                                <div class="stat-value">{{ queue.get_active_count }}</div>
                            </div>
                            <div>
                                <div class="stat-label">Status</div>
                                <div class="stat-value">{{ queue.get_status_display }}</div>
                            </div>
                            {% if queue.id in active_queues %}
                                <div class="leave-queue-btn {% if not is_editing %}d-none{% endif %}">
                                    <form method="POST" action="{% url 'queue:leave_queue' queue.id %}" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to leave this queue? This action cannot be undone.');">
                                        {% csrf_token %}
                                        <input type="hidden" name="queue_id" value="{{ queue.id }}">
                                        <button type="submit" class="btn btn-danger">
                                            Leave Queue
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card">You are not in a queue.</div>
            {% endif %}
        </div>

        <div class="card d-md-inline-flex">
            <div class="card-title">Join Queue by Code</div>
            <form class="join-form" method="POST" action="{% url 'queue:join' %}">
                {% csrf_token %}
                <input type="text" class="join-input" placeholder="Enter queue code" name="queue_code">
                <button type="submit" class="btn join-btn">Join Queue</button>
            </form>
        </div>
    </main>

    <script>
    function toggleEditMode() {
        const leaveButtons = document.querySelectorAll('.leave-queue-btn');
        const editBtn = document.querySelector('.edit-btn');

        // Check if we are currently in editing mode
        let isEditing = editBtn.textContent === 'Done';

        leaveButtons.forEach(btn => {
            if (isEditing) {
                btn.classList.add('d-none'); // Hide buttons when editing
            } else {
                btn.classList.remove('d-none'); // Show buttons when not editing
            }
        });

        // Toggle the button text and style
        editBtn.textContent = isEditing ? 'Edit' : 'Done';
        editBtn.style.backgroundColor = isEditing ? '#6c757d' : '#28a745';
    }
    </script>
{% endblock %}



