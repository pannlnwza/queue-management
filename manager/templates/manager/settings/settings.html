{% extends 'sidebar_manage.html' %}

{% block content %}
    <body class="bg-base-100 p-6">
    <div class="breadcrumbs text-sm mb-0">
        <ul>
            <li>
                <a href="{% url 'manager:your-queue' %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                        <path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h1.879a1.5 1.5 0 0 1 1.06.44l1.122 1.12A1.5 1.5 0 0 0 9.62 4H11.5A1.5 1.5 0 0 1 13 5.5v1H3v-3ZM3.081 8a1.5 1.5 0 0 0-1.423 1.974l1 3A1.5 1.5 0 0 0 4.081 14h7.838a1.5 1.5 0 0 0 1.423-1.026l1-3A1.5 1.5 0 0 0 12.919 8H3.081Z"/>
                    </svg>
                    Your Queues
                </a>
            </li>
            <li>
                <a class="font-serif" href="{% url 'manager:manage_waitlist' queue.id %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                        <path d="M4.5 7c.681 0 1.3-.273 1.75-.715C6.7 6.727 7.319 7 8 7s1.3-.273 1.75-.715A2.5 2.5 0 1 0 11.5 2h-7a2.5 2.5 0 0 0 0 5ZM6.25 8.097A3.986 3.986 0 0 1 4.5 8.5c-.53 0-1.037-.103-1.5-.29v4.29h-.25a.75.75 0 0 0 0 1.5h.5a.754.754 0 0 0 .138-.013A.5.5 0 0 0 3.5 14H6a.5.5 0 0 0 .5-.5v-3A.5.5 0 0 1 7 10h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .112-.013c.045.009.09.013.138.013h.5a.75.75 0 1 0 0-1.5H13V8.21c-.463.187-.97.29-1.5.29a3.986 3.986 0 0 1-1.75-.403A3.986 3.986 0 0 1 8 8.5a3.986 3.986 0 0 1-1.75-.403Z"/>
                    </svg>
                    {{ queue.name| title }}
                </a>
            </li>
            <li>
                <span class="inline-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                        <path fill-rule="evenodd"
                              d="M6.955 1.45A.5.5 0 0 1 7.452 1h1.096a.5.5 0 0 1 .497.45l.17 1.699c.484.12.94.312 1.356.562l1.321-1.081a.5.5 0 0 1 .67.033l.774.775a.5.5 0 0 1 .034.67l-1.08 1.32c.25.417.44.873.561 1.357l1.699.17a.5.5 0 0 1 .45.497v1.096a.5.5 0 0 1-.45.497l-1.699.17c-.12.484-.312.94-.562 1.356l1.082 1.322a.5.5 0 0 1-.034.67l-.774.774a.5.5 0 0 1-.67.033l-1.322-1.08c-.416.25-.872.44-1.356.561l-.17 1.699a.5.5 0 0 1-.497.45H7.452a.5.5 0 0 1-.497-.45l-.17-1.699a4.973 4.973 0 0 1-1.356-.562L4.108 13.37a.5.5 0 0 1-.67-.033l-.774-.775a.5.5 0 0 1-.034-.67l1.08-1.32a4.971 4.971 0 0 1-.561-1.357l-1.699-.17A.5.5 0 0 1 1 8.548V7.452a.5.5 0 0 1 .45-.497l1.699-.17c.12-.484.312-.94.562-1.356L2.629 4.107a.5.5 0 0 1 .034-.67l.774-.774a.5.5 0 0 1 .67-.033L5.43 3.71a4.97 4.97 0 0 1 1.356-.561l.17-1.699ZM6 8c0 .538.212 1.026.558 1.385l.057.057a2 2 0 0 0 2.828-2.828l-.058-.056A2 2 0 0 0 6 8Z"
                              clip-rule="evenodd"/>
                    </svg>
                    Settings
                </span>
            </li>
        </ul>
    </div>
    <div class="flex justify-between items-center mb-5">
        <h1 class="text-2xl font-bold antialiased font-sans">Queue Settings</h1>
    </div>
    <div>

        <form method="post" action="{% url 'manager:edit_queue' queue.id %}" class="space-y-6">
            {% csrf_token %}
            <div class="flex justify-between items-start space-x-6">
                <!-- Left Section: Settings Form -->
                <div class="card border-2 border-base-200 max-w-4xl w-full px-7 pt-3 pb-7">
                    <div class="space-y-5">
                        <div class="form-control my-3">
                            <span class="label-text font-medium px-1 mb-2">Logo</span>
                            <div class="flex items-center gap-4">
                                <img src="{{ queue.get_logo_url }}" alt="Queue Logo"
                                     class="w-20 h-20 object-cover rounded-md border border-base-300"
                                     onerror="this.src='/static/default-logo.png'"/>
                                <div class="flex flex-col">
                                    <input type="file" name="logo" accept="image/*"
                                           class="file-input file-input-sm file-input-bordered w-full max-w-xs"/>
                                    <span class="text-xs text-base-content/60 mt-1 ml-1">Upload a new logo to replace the existing one.</span>
                                </div>
                            </div>
                        </div>
                        <div class="divider"></div>

                        <!-- Queue Name -->
                        <div class="form-control my-3">
                            <span class="label-text font-medium px-1 mb-2">Name*</span>
                            <input type="text" name="name" value="{{ queue.name }}"
                                   class="input input-bordered w-full max-w-xs" required/>
                        </div>
                        <div class="divider"></div>

                        <div class="form-control my-3">
                            <label class="label cursor-pointer flex items-center space-x-2">
                                <span class="label-text font-medium">Status</span>
                                <input type="checkbox" name="is_closed" {% if not queue.is_closed %}checked{% endif %}
                                       class="toggle toggle-success"/>
                            </label>
                            <span class="label-text-alt text-base-content/60 mx-1">Toggle to mark the queue as opened or closed.</span>
                        </div>
                        <div class="divider"></div>

                        <div class="form-control my-3">
                            <span class="label-text font-medium px-1 mb-2">Description</span>
                            <textarea name="description" class="textarea textarea-bordered w-full max-w-lg"
                                      rows="3">{{ queue.description }}</textarea>
                        </div>
                        <div class="divider"></div>


                        <!-- Hours Section -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Start hour</span>
                                </label>
                                <input type="time" id="open_time" name="open_time"
                                       value="{{ queue.open_time|time:'H:i' }}"
                                       class="input input-bordered"/>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">End hour</span>
                                </label>
                                <input type="time" id="close_time" name="close_time"
                                       value="{{ queue.close_time|time:'H:i' }}"
                                       class="input input-bordered"/>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Resources Card -->
                        <div class="card card-compact border-2 border-base-200 bg-base-100 cursor-pointer my-2"
                             onclick="window.location.href='/manager/settings/{{ queue.id }}/resources'">
                            <div class="card-body">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <h2 class="card-title">{{ resource_name |title }}s<span
                                                class="badge badge-sm">{{ resources | length }}</span></h2>
                                        <p class="text-base-content/70">Create and manage your resources.</p>
                                    </div>
                                    <div class="text-base-content/70">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services Card -->
                        <div class="card card-compact border-2 border-base-200 bg-base-100 cursor-pointer my-2"
                             onclick="window.location.href='/qr-serve'">
                            <div class="card-body">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <h2 class="card-title">Services<span
                                                class="badge badge-sm">{{ resources| length }}</span></h2>
                                        <p class="text-base-content/70">Create and manage your services.</p>
                                    </div>
                                    <div class="text-base-content/70">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <div class="card border-2 border-base-200 px-7 pt-2 pb-5 h-auto w-full">
                    <div class="form-control my-4">
                        <label for="map" class="label-text font-medium px-1">Location</label>
                        <span class="label-text-alt text-base-content/60 mx-1">Mark location by dragging the blue marker</span>

                        <!-- Map Container with Fixed Height -->
                        <div id="map" class="mt-4 rounded-md border border-base-300" style="height: 400px;"></div>
                        <p id="locationError" class="text-red-500 text-sm mt-2" style="display:none;">Please select a
                            location on the map.</p>
                    </div>

                    <!-- Hidden Inputs for Latitude and Longitude -->
                    <input type="hidden" name="latitude" id="id_latitude" value="{{ queue.latitude }}" required>
                    <input type="hidden" name="longitude" id="id_longitude" value="{{ queue.longitude }}" required>

                </div>
                <button type="submit" class="btn btn-sm btn-primary w-36 self-end">Save</button>


                <!-- Save Button Below Location Card -->


            </div>
        </form>
    </div>
    </body>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        var initialLat = {{ queue.latitude|default:13.7563 }};
        var initialLng = {{ queue.longitude|default:100.5018 }};
        var map = L.map('map').setView([initialLat, initialLng], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add a draggable marker with the initial position
        var marker = L.marker([initialLat, initialLng], {draggable: true}).addTo(map);

        // Update hidden inputs when the marker is dragged
        marker.on('dragend', function (event) {
            var lat = marker.getLatLng().lat;
            var lng = marker.getLatLng().lng;
            document.getElementById('id_latitude').value = lat;
            document.getElementById('id_longitude').value = lng;
        });

    </script>

{% endblock %}
