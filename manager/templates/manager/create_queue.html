{% extends 'base.html' %}
{% block content %}
    <div class="container mx-auto px-4">
        <!-- Step Indicator -->
        <div class="mb-5 flex justify-center">
            <ul class="steps steps-horizontal w-full max-w-2xl" id="stepIndicator">
                {% for step_number in total_steps_list %}
                    <li id="step-{{ step_number }}" class="step {% if step == step_number %}step-primary{% endif %}">
                        Step {{ step_number }}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Form Container -->
        <div class="card bg-base-100 border-2 border-base-200 max-w-4xl mx-auto">
            <div class="card-body">
                <form method="post" id="multiStepForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="step-form-content" id="stepFormContent">
                        <!-- Step 1: Queue Details -->
                        <div id="step1" class="step-section {% if step != 1 %}hidden{% endif %}">
                            <h2 class="text-2xl font-bold">Queue Details</h2>
                            <p class="text-base-content/70 mt-2">Fill in the basic details of your queue.</p>
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text text-base font-medium">Name*</span>
                                </label>
                                <input type="text" name="name"
                                       class="input input-bordered w-full focus:input-primary"
                                       required>
                                {% if form.name.errors %}
                                    <div class="text-error text-sm mt-1">{{ form.name.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Description Field -->
                            <div class="form-control w-full mb-2">
                                <label class="label">
                                    <span class="label-text text-base font-medium">Description*</span>
                                </label>
                                <textarea name="{{ form.description.name }}"
                                          class="textarea textarea-bordered h-24 focus:textarea-primary"
                                          required>{% if form.description.value %}
                                    {{ form.description.value }}{% endif %}</textarea>
                                {% if form.description.errors %}
                                    <div class="text-error text-sm mt-1">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Two Column Layout -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Category Field -->
                                <div class="form-control w-full">
                                    <label class="label">
                                        <span class="label-text text-base font-medium">Select Category*</span>
                                    </label>
                                    <select name="{{ form.category.name }}"
                                            class="select select-bordered w-full focus:select-primary"
                                            required>
                                        {% for value, label in form.category.field.choices %}
                                            <option value="{{ value }}"
                                                    {% if form.category.value == value|stringformat:"s" %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.category.errors %}
                                        <div class="text-error text-sm mt-1">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <!-- Logo Upload Field -->
                                <div class="form-control w-full">
                                    <div class="form-control w-full">
                                        <label class="label">
                                            <span class="label-text text-base font-medium">Insert Your Logo</span>
                                            <span class="label-text-alt text-base-content/60">(Optional)</span>
                                        </label>
                                        <input type="file" name="logo"
                                               class="file-input file-input-bordered w-full" accept="image/*"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Hours & Location -->
                        <div id="step2" class="step-section {% if step != 2 %}hidden{% endif %}">
                            <h2 class="text-2xl font-bold">Hours & Location</h2>
                            <form method="post" id="queueForm" class="">
                                {% csrf_token %}
                                <div class="flex flex-col sm:flex-row justify-start gap-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text font-medium">Opening Time</span>
                                        </label>
                                        <input type="time" id="open_time" name="open_time"
                                               value="{{ queue.open_time|time:'H:i' }}"
                                               class="input input-bordered"/>
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text font-medium">Closing Time</span>
                                        </label>
                                        <input type="time" id="close_time" name="close_time"
                                               value="{{ queue.open_time|time:'H:i' }}"
                                               class="input input-bordered"/>
                                    </div>
                                </div>
                                <!-- Location Section -->
                                <h3 class="text-lg font-semibold mb-2 mt-3">Location Details</h3>

                                <!-- Search Box -->
                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text font-medium">Search Location</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text"
                                               id="searchInput"
                                               class="input input-bordered flex-1"
                                               placeholder="Enter location to search">
                                        <button type="button" id="useLocationButton"
                                                class="items-center p-2 bg-transparent border-2 border-blue-500 rounded-full hover:bg-blue-100 inline-flex ml-2">
                                            <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png"
                                                 alt="Use My Location"
                                                 class="w-5 h-5 mr-2 cursor-pointer"/>
                                            <span class="text-blue-500 font-medium">Your location</span>
                                        </button>
                                    </div>

                                    <!-- Coordinates Input -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium">Latitude</span>
                                            </label>
                                            <input type="number"
                                                   id="latitudeInput"
                                                   class="input input-bordered w-full"
                                                   placeholder="Latitude"
                                                   step="any">
                                        </div>
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium">Longitude</span>
                                            </label>
                                            <input type="number"
                                                   id="longitudeInput"
                                                   class="input input-bordered w-full"
                                                   placeholder="Longitude"
                                                   step="any">
                                        </div>
                                    </div>

                                    <!-- Map -->
                                    <div class="rounded-box overflow-hidden border border-base-300">
                                        <div id="map" class="w-full" style="height: 400px;"></div>
                                    </div>
                                </div>

                                <!-- Hidden Inputs -->
                                <input type="hidden" name="latitude" id="id_latitude" required>
                                <input type="hidden" name="longitude" id="id_longitude" required>
                            </form>
                        </div>

                        <!-- Step 3: Add Resource -->
                        <div id="step3" class="step-section {% if step != 3 %}hidden{% endif %}">
                            <h2 class="text-2xl font-bold">Add Resource</h2>
                            <p class="text-base-content/70 mt-2">Add resources related to the queue.</p>
                            <div class="form-content">
                                <label for="resource_name" class="block">Resource Name</label>
                                <input type="text" id="resource_name" name="resource_name"
                                       class="input input-bordered w-full" required>

                                <label for="resource_type" class="block mt-4">Resource Type</label>
                                <select id="resource_type" name="resource_type" class="select select-bordered w-full"
                                        required>
                                    <option value="table">Table</option>
                                    <option value="counter">Counter</option>
                                    <option value="doctor">Doctor</option>
                                    <option value="service">Service</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" id="previousBtn" class="btn btn-outline gap-2" onclick="changeStep(-1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd"
                                      d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Previous
                        </button>
                        <button type="button" id="nextBtn" class="btn btn-primary gap-2" onclick="changeStep(1)">
                            {% if step < total_steps %}
                                Next
                            {% else %}
                                Submit
                            {% endif %}
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd"
                                      d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                      clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css"/>
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>

    <script>
        let currentStep = {{ step }}; // Set the current step from Django context
        const totalSteps = {{ total_steps }};
        const stepFormContent = document.getElementById('stepFormContent');

        // Function to show the correct step and update step indicator
        function showStep(step) {
            // Hide all other content
            const stepSections = document.querySelectorAll('.step-section');
            stepSections.forEach(section => section.classList.add('hidden'));

            // Show the selected step
            document.getElementById('step' + step).classList.remove('hidden');

            // Update the step indicators
            const stepIndicators = document.querySelectorAll('.step');
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 === step) {
                    indicator.classList.add('step-primary');
                } else {
                    indicator.classList.remove('step-primary');
                }
            });
        }

        // Handle next and previous button clicks
        function changeStep(stepChange) {
            currentStep += stepChange;

            // Ensure currentStep stays within bounds
            if (currentStep < 1) currentStep = 1;
            if (currentStep > totalSteps) currentStep = totalSteps;

            // Update form step visibility and step indicators
            showStep(currentStep);

            // Disable or enable next/previous buttons based on current step
            if (currentStep === 1) {
                document.getElementById('previousBtn').disabled = true;
            } else {
                document.getElementById('previousBtn').disabled = false;
            }

            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').textContent = "Submit";
            } else {
                document.getElementById('nextBtn').textContent = "Next";
            }
        }

        // Initialize the form display on page load
        showStep(currentStep);
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([100.5018, 13.7563]),
                zoom: 13
            })
        });

        const markerStyle = new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                src: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                scale: 0.08
            })
        });

        const markerSource = new ol.source.Vector();
        const markerLayer = new ol.layer.Vector({
            source: markerSource,
            style: markerStyle
        });
        map.addLayer(markerLayer);

        let markerFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([100.5018, 13.7563]))
        });
        markerSource.addFeature(markerFeature);

        function updateInputs(lon, lat) {
            document.getElementById('id_latitude').value = lat?.toFixed(6) || '';
            document.getElementById('id_longitude').value = lon?.toFixed(6) || '';
            document.getElementById('latitudeInput').value = lat?.toFixed(6) || '';
            document.getElementById('longitudeInput').value = lon?.toFixed(6) || '';
        }

        const modifyInteraction = new ol.interaction.Modify({
            source: markerSource,
            hitDetection: markerLayer,
        });
        map.addInteraction(modifyInteraction);

        modifyInteraction.on('modifyend', function (event) {
            if (event.features.getLength() > 0) {
                const feature = event.features.item(0);
                const coordinates = ol.proj.toLonLat(feature.getGeometry().getCoordinates());
                updateInputs(coordinates[0], coordinates[1]);
            }
        });

        map.on('singleclick', function (event) {
            const coordinates = ol.proj.toLonLat(event.coordinate);
            const [lon, lat] = coordinates;

            markerSource.clear();
            const newMarkerFeature = new ol.Feature({
                geometry: new ol.geom.Point(event.coordinate)
            });
            markerSource.addFeature(newMarkerFeature);

            updateInputs(lon, lat);
        });

        document.getElementById('useLocationButton').addEventListener('click', function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    console.log(`User location: Lat = ${lat}, Lon = ${lon}`);

                    const coordinates = ol.proj.fromLonLat([lon, lat]);
                    map.getView().setCenter(coordinates);
                    map.getView().setZoom(13);

                    markerSource.clear();
                    const newMarkerFeature = new ol.Feature({
                        geometry: new ol.geom.Point(coordinates)
                    });
                    markerSource.addFeature(newMarkerFeature);
                    updateInputs(lon, lat);
                }, function () {
                    alert("Error: The Geolocation service failed.");
                });
            } else {
                alert("Error: Your browser does not support geolocation.");
            }
        });

        document.getElementById('searchButton').addEventListener('click', searchLocation);
        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchLocation();
            }
        });

        function searchLocation() {
            var query = document.getElementById('searchInput').value.trim();

            if (!query) {
                alert("Please enter a location to search.");
                return;
            }

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = parseFloat(data[0].lat);
                        var lon = parseFloat(data[0].lon);
                        const coordinates = ol.proj.fromLonLat([lon, lat]);
                        map.getView().setCenter(coordinates);
                        map.getView().setZoom(13);
                        markerSource.clear();
                        let newMarkerFeature = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates)
                        });
                        markerSource.addFeature(newMarkerFeature);
                        updateInputs(lon, lat);
                    } else {
                        alert("Location not found. Please try again.");
                    }
                })
                .catch(error => {
                    console.error("Error searching location:", error);
                    alert("Unable to search location. Please try again later.");
                });
        }

        document.getElementById('queueForm').addEventListener('submit', function (event) {
            const latitude = document.getElementById('id_latitude').value;
            const longitude = document.getElementById('id_longitude').value;

            if (!latitude || !longitude) {
                event.preventDefault();
                alert('Please select a location on the map before proceeding.');
            }
        });


    </script>

{% endblock %}
