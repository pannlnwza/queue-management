{% extends 'sidebar.html' %}

{% block content %}
        <div class="w-full max-w-full">
            <div class="breadcrumbs text-sm mb-0">
              <ul>
                <li>
                  <a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                      <path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h1.879a1.5 1.5 0 0 1 1.06.44l1.122 1.12A1.5 1.5 0 0 0 9.62 4H11.5A1.5 1.5 0 0 1 13 5.5v1H3v-3ZM3.081 8a1.5 1.5 0 0 0-1.423 1.974l1 3A1.5 1.5 0 0 0 4.081 14h7.838a1.5 1.5 0 0 0 1.423-1.026l1-3A1.5 1.5 0 0 0 12.919 8H3.081Z" />
                    </svg>
                    Your Queues
                  </a>
                </li>
                <li>
                  <a class="font-serif" href="{% url 'manager:manage_waitlist' queue.id %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                      <path d="M4.5 7c.681 0 1.3-.273 1.75-.715C6.7 6.727 7.319 7 8 7s1.3-.273 1.75-.715A2.5 2.5 0 1 0 11.5 2h-7a2.5 2.5 0 0 0 0 5ZM6.25 8.097A3.986 3.986 0 0 1 4.5 8.5c-.53 0-1.037-.103-1.5-.29v4.29h-.25a.75.75 0 0 0 0 1.5h.5a.754.754 0 0 0 .138-.013A.5.5 0 0 0 3.5 14H6a.5.5 0 0 0 .5-.5v-3A.5.5 0 0 1 7 10h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .112-.013c.045.009.09.013.138.013h.5a.75.75 0 1 0 0-1.5H13V8.21c-.463.187-.97.29-1.5.29a3.986 3.986 0 0 1-1.75-.403A3.986 3.986 0 0 1 8 8.5a3.986 3.986 0 0 1-1.75-.403Z" />
                    </svg>
                      {{ queue.name| title}}
                  </a>
                </li>
                <li>
                  <span class="inline-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                      <path d="M8 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM3.156 11.763c.16-.629.44-1.21.813-1.72a2.5 2.5 0 0 0-2.725 1.377c-.136.287.102.58.418.58h1.449c.01-.077.025-.156.045-.237ZM12.847 11.763c.02.08.036.16.046.237h1.446c.316 0 .554-.293.417-.579a2.5 2.5 0 0 0-2.722-1.378c.374.51.653 1.09.813 1.72ZM14 7.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM3.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM5 13c-.552 0-1.013-.455-.876-.99a4.002 4.002 0 0 1 7.753 0c.136.535-.324.99-.877.99H5Z" />
                    </svg>
                    Participants
                  </span>
                </li>
              </ul>
            </div>
        <div class="flex justify-between items-center mb-5">
                <h1 class="text-2xl font-bold antialiased font-sans">Participants</h1>
                <div class="ml-auto">
                    <a class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                          <path d="M8.5 4.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 13c.552 0 1.01-.452.9-.994a5.002 5.002 0 0 0-9.802 0c-.109.542.35.994.902.994h8ZM12.5 3.5a.75.75 0 0 1 .75.75v1h1a.75.75 0 0 1 0 1.5h-1v1a.75.75 0 0 1-1.5 0v-1h-1a.75.75 0 0 1 0-1.5h1v-1a.75.75 0 0 1 .75-.75Z" />
                        </svg>
                        Add Participant
                    </a>
                </div>
            </div>
            <div class="justify-between inline-flex mb-4">
                <div class="form-control">
                    <label class="input input-bordered flex items-center w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                        <input type="text" placeholder="Search" class="pl-2 w-full"/>
                    </label>
                </div>
                <details class="dropdown">
                    <summary class="btn no-animation mx-2" id="selectedTimeFilter">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                          <path d="M5.75 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM5 10.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM10.25 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM7.25 8.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM8 9.5A.75.75 0 1 0 8 11a.75.75 0 0 0 0-1.5Z" />
                          <path fill-rule="evenodd" d="M4.75 1a.75.75 0 0 0-.75.75V3a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2V1.75a.75.75 0 0 0-1.5 0V3h-5V1.75A.75.75 0 0 0 4.75 1ZM3.5 7a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v4.5a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7Z" clip-rule="evenodd" />
                        </svg>
                        {{ time_filter_option_display }}
                    </summary>
                    <ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                        <li><a href="?time_filter=all_time&state_filter={{ state_filter_option }}">All time</a></li>
                        <li><a href="?time_filter=today&state_filter={{ state_filter_option }}">Today</a></li>
                        <li><a href="?time_filter=this_week&state_filter={{ state_filter_option }}">This week</a></li>
                        <li><a href="?time_filter=this_month&state_filter={{ state_filter_option }}">This month</a></li>
                        <li><a href="?time_filter=this_year&state_filter={{ state_filter_option }}">This year</a></li>
                    </ul>
                </details>

                <details class="dropdown">
                    <summary class="btn no-animation" id="selectedStateFilter">
                        {{ state_filter_option_display }}
                    </summary>
                    <ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                        <li><a href="?time_filter={{ time_filter_option }}&state_filter=any_state">Any state</a></li>
                        <li><a href="?time_filter={{ time_filter_option }}&state_filter=waiting">Waiting</a></li>
                        <li><a href="?time_filter={{ time_filter_option }}&state_filter=completed">Completed</a></li>
                        <li><a href="?time_filter={{ time_filter_option }}&state_filter=serving" >Serving</a></li>
                    </ul>
                </details>
            </div>

            <div class="overflow-x-auto">
                <table class="table min-w-full bg-base-100 divide-y divide-gray-200" id="participantTable">
                    <thead>
                    <tr>
                        <th class="w-10 px-2 py-3"></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                    </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        {% for participant in participant_set %}
                            <tr>
                                <td class="w-10 px-2 py-4">
                                    <div class="form-control max-w-sm">
                                      <label class="label cursor-pointer">
                                        <input type="checkbox" class="checkbox checkbox-primary border-base-content" />
                                      </label>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-3">
                                        <div class="avatar">
                                            <div class="w-9 rounded-full">
                                                <img src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp" />
                                            </div>
                                        </div>
                                        <span class="font-semibold">{{ participant.name }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">{{ participant.visits }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">{{ participant.state }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">{{ participant.joined_at }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="dropdown dropdown-left dropdown-end">
                                        <div tabindex="0" role="button" class="btn btn-square btn-sm btn-ghost">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                                                <path d="M3 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM8.5 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM15.5 8.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" />
                                            </svg>
                                        </div>
                                      <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                                        <li>
                                            <a
                                                onclick="openEditDrawer(this)"
                                                data-id="{{ participant.id }}"
                                                data-name="{{ participant.name }}"
                                                data-notes="{{ participant.note }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                                                    <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" />
                                                    <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" />
                                                </svg>Edit
                                            </a>
                                        </li>
                                        <li>
                                            <a id="participantDetail" class="text-red-500" onclick="openDeleteModal({{ participant.id }})">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                                                    <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                                </svg>Delete
                                            </a>
                                        </li>
                                    </ul>
                                    </div>
                                </td>
                            </tr>

                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
       <!-- Delete Modal -->
<input type="checkbox" id="deleteModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Are you sure you want to delete this record?</h3>
    <p class="py-4">This action cannot be undone.</p>
    <div class="modal-action">
      <button class="btn btn-error" id="confirmDeleteButton">Delete</button>
      <label for="deleteModal" class="btn">Cancel</label>
    </div>
  </div>
</div>

<!-- Edit Sidebar Drawer -->
<div class="drawer drawer-end drawer-overlay z-100">
    <input id="editDrawer" type="checkbox" class="drawer-toggle"/>
    <div class="drawer-content">
    <div class="drawer-side">
        <label for="editDrawer" aria-label="close sidebar" class="drawer-overlay"></label>
        <div class="bg-base-100 min-h-full w-100">
            <div class="p-4 space-y-4">
                <div class="drawer-header">
                    <h2 class="text-lg font-bold">Edit Participant</h2>
                    <hr class="border-base-300" />
                </div>

                <form id="editForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="participant_id" name="participant_id">

                    <!-- Name Field -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Name*</span>
                        </label>
                        <input type="text" id="edit_name" name="name" class="input input-bordered w-full" />
                    </div>

                    <!-- Phone Field -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Phone</span>
                        </label>
                        <input type="tel" id="edit_phone" name="phone" placeholder="Ex. 081 234 5678" class="input input-bordered w-full" />
                    </div>

                    <!-- Notes Field -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Note</span>
                        </label>
                        <textarea id="edit_notes" name="notes" class="textarea textarea-bordered w-full"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let deleteParticipantId = null;

function deleteParticipant(id) {
    fetch(`/manager/delete_participant/${id}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
        .then(response => {
            if (response.ok) {
                console.log("Participant deleted successfully!");
                location.reload();
            } else {
                console.error("Failed to delete participant.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
}

function openDeleteModal(participantId) {
    deleteParticipantId = participantId;
    document.getElementById('deleteModal').checked = true;
}

document.getElementById('confirmDeleteButton').addEventListener('click', () => {
    if (deleteParticipantId) {
        deleteParticipant(deleteParticipantId);
        document.getElementById('deleteModal').checked = false;
    }
});

function openEditDrawer(element) {
    const participantId = element.getAttribute('data-id');
    const participantName = element.getAttribute('data-name');
    const participantPhone = element.getAttribute('data-phone');
    const participantNotes = element.getAttribute('data-notes');

    document.getElementById('participant_id').value = participantId;
    document.getElementById('edit_name').value = participantName || '';
    document.getElementById('edit_phone').value = participantPhone || '';
    document.getElementById('edit_notes').value = participantNotes || '';

    document.getElementById('editForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const updatedData = {
            id: document.getElementById('participant_id').value,
            name: document.getElementById('edit_name').value,
            phone: document.getElementById('edit_phone').value,
            notes: document.getElementById('edit_notes').value,
        };

        updateParticipant(updatedData);
    });

    function updateParticipant(data) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/manager/edit_participant/${data.id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    console.log("Participant updated successfully!");
                    alert("Participant updated successfully!");
                    location.reload();
                } else {
                    console.error("Failed to update participant.");
                    alert("Failed to update participant.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while updating the participant.");
            });
    }


}
</script>



{% endblock %}