{% extends 'base.html' %}
{% block content %}
<div class="flex justify-center items-center">
  <ul class="steps steps-vertical lg:steps-horizontal steps-center">
    <li class="step step-primary p-2">Queue Setup</li>
    <li class="step step-primary p-2">Specify Hours & Location</li>
    <li class="step p-2">Add Resources</li>
  </ul>
</div>


<div class="card border-2 border-base-200 max-w-4xl w-full sm:w-3/4 md:w-1/2 mx-auto p-6 mt-4">
    <form method="post">
        {% csrf_token %}

        <div class="flex justify-center">
            <div class="flex gap-8">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Opening Time</span>
                </label>
                {{ form.open_time }}
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Closing Time</span>
                </label>
                {{ form.close_time }}
              </div>
            </div>
        </div>

        <div class="form-group mb-4">
                <label for="searchInput">Search for Location</label>
                <div class="relative mt-3">
                    <input type="text"
                           id="searchInput"
                           class="input input-bordered w-full pr-12"
                           placeholder="Enter location to search">
                    <button type="button"
                            id="searchButton"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-2 h-auto min-h-0">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-5 w-5"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-group mb-4">
                <label>Enter Latitude and Longitude (Optional)</label>
                <div class="grid gap-4">
                    <div class="flex gap-4">
                        <input type="number"
                               id="latitudeInput"
                               class="mt-3 input input-bordered w-full"
                               placeholder="Latitude"
                               step="any"
                                name="latitudeInput"
                                required>
                        <input type="number"
                               id="longitudeInput"
                               class="mt-3 input input-bordered w-full"
                               placeholder="Longitude"
                               step="any"
                                name="longitudeInput"
                                required>
                        <button type="button"
                                id="latLngSearchButton"
                                class="mt-4 w-10 h-10 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-5 w-5"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group mb-4">
                <label>Mark your queue location by dragging the blue marker.</label>
                <div id="map" class="mt-4" style="height: 400px;"></div>
            </div>
            <input type="hidden" name="latitude" id="id_latitude" required>
            <input type="hidden" name="longitude" id="id_longitude" required>
        <div class="flex justify-between items-center">
            <!-- Left-aligned button -->
            <a href="{% url 'manager:create_queue_step' step="1" %}" class="btn btn-primary">Back</a>
            <!-- Right-aligned button -->
            <button type="submit" class="btn btn-primary" id="nextButton">Next</button>
        </div>
    </form>
</div>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([13.7563, 100.5018], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var marker = L.marker([13.7563, 100.5018], { draggable: true }).addTo(map);

    function updateInputsFromMarker() {
        var lat = marker.getLatLng().lat.toFixed(6);
        var lng = marker.getLatLng().lng.toFixed(6);
        document.getElementById('id_latitude').value = lat;
        document.getElementById('id_longitude').value = lng;
        document.getElementById('latitudeInput').value = lat;
        document.getElementById('longitudeInput').value = lng;
    }

    function updateMarkerFromInputs() {
        var lat = parseFloat(document.getElementById('latitudeInput').value);
        var lng = parseFloat(document.getElementById('longitudeInput').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            marker.setLatLng([lat, lng]);
            map.setView([lat, lng], 13);
            document.getElementById('id_latitude').value = lat.toFixed(6);
            document.getElementById('id_longitude').value = lng.toFixed(6);
        } else {
            alert("Please enter valid latitude and longitude.");
        }
    }

    marker.on('dragend', updateInputsFromMarker);

    document.getElementById('latitudeInput').addEventListener('change', updateMarkerFromInputs);
    document.getElementById('longitudeInput').addEventListener('change', updateMarkerFromInputs);

    document.getElementById('latLngSearchButton').addEventListener('click', function () {
    const lat = document.getElementById('latitudeInput').value.trim();
    const lng = document.getElementById('longitudeInput').value.trim();

    if (!lat || !lng) {
        alert("Please enter both latitude and longitude values.");
        return;
    }

    updateMarkerFromInputs();
    });

    document.getElementById('searchButton').addEventListener('click', function () {
        searchLocation();
    });

    document.getElementById('searchInput').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchLocation();
        }

    });


    function searchLocation() {
        var query = document.getElementById('searchInput').value.trim();

        if (!query) {
            alert("Please enter a location to search.");
            return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lon = parseFloat(data[0].lon);

                    map.setView([lat, lon], 13);
                    marker.setLatLng([lat, lon]);
                    document.getElementById('id_latitude').value = lat.toFixed(6);
                    document.getElementById('id_longitude').value = lon.toFixed(6);
                    document.getElementById('latitudeInput').value = lat.toFixed(6);
                    document.getElementById('longitudeInput').value = lon.toFixed(6);
                } else {
                    alert("Location not found. Please try again.");
                }
            })
            .catch(error => {
                console.error("Error searching location:", error);
                alert("Unable to search location. Please try again later.");
            });
    }

    document.getElementById('nextButton').addEventListener('click', function (event) {
    // Call searchLocation()
    searchLocation();

    // Delay the null value check by 2 seconds (2000 milliseconds)
    setTimeout(function () {
        var latitude = document.getElementById('id_latitude').value;
        var longitude = document.getElementById('id_longitude').value;

        if (!latitude || !longitude) {
            event.preventDefault();
            alert("Please provide a location for the queue.");
        }
    }, 3000); // 2000 milliseconds = 2 seconds
});
</script>
{% endblock %}