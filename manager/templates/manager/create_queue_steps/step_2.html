{% extends 'base.html' %}
{% block content %}
<div class="flex justify-center items-center">
  <ul class="steps steps-vertical lg:steps-horizontal steps-center">
    <li class="step step-primary p-2">Queue Setup</li>
    <li class="step step-primary p-2">Specify Hours & Location</li>
    <li class="step p-2">Add Resources</li>
  </ul>
</div>

<div class="card border-2 border-base-200 max-w-4xl w-full sm:w-3/4 md:w-1/2 mx-auto p-6 mt-4">
    <form method="post" id="queueForm">
        {% csrf_token %}

        <div class="flex justify-center">
            <div class="flex gap-8">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Opening Time</span>
                </label>
                {{ form.open_time }}
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Closing Time</span>
                </label>
                {{ form.close_time }}
              </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <label for="searchInput">Search for Location</label>
            <div class="relative mt-3">
                <input type="text"
                       id="searchInput"
                       class="input input-bordered w-full pr-12"
                       placeholder="Enter location to search">
                <button type="button"
                        id="searchButton"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 h-auto min-h-0">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="form-group mb-4">
            <label>Enter Latitude and Longitude (Optional)</label>
            <div class="grid gap-4">
                <div class="flex gap-4">
                    <input type="number"
                           id="latitudeInput"
                           class="mt-3 input input-bordered w-full"
                           placeholder="Latitude"
                           step="any"
                           name="latitudeInput">
                    <input type="number"
                           id="longitudeInput"
                           class="mt-3 input input-bordered w-full"
                           placeholder="Longitude"
                           step="any"
                           name="longitudeInput">
                </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <label>Mark your queue location by dragging the marker.</label>
            <div id="map" class="mt-4" style="height: 400px;"></div>
        </div>

        <input type="hidden" name="latitude" id="id_latitude" required>
        <input type="hidden" name="longitude" id="id_longitude" required>
        <div class="flex justify-between items-center">
            <!-- Left-aligned button -->
            <a href="{% url 'manager:create_queue_step' step='1' %}" class="btn btn-primary">Previous</a>
            <!-- Right-aligned button -->
            <button type="submit" class="btn btn-primary">Next</button>
        </div>
    </form>
</div>

<!-- OpenLayers CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css" />
<script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>

<script>
    const map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([100.5018, 13.7563]),
            zoom: 13
        })
    });

    const markerStyle = new ol.style.Style({
        image: new ol.style.Icon({
            anchor: [0.5, 1],
            src: 'https://openlayers.org/en/v4.6.5/examples/data/icon.png'
        })
    });

    const markerSource = new ol.source.Vector();
    const markerLayer = new ol.layer.Vector({
        source: markerSource,
    });
    map.addLayer(markerLayer);

    let markerFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([100.5018, 13.7563]))
    });
    markerFeature.setStyle(markerStyle);
    markerSource.addFeature(markerFeature);

    function updateInputs(lon, lat) {
        document.getElementById('id_latitude').value = lat.toFixed(6);
        document.getElementById('id_longitude').value = lon.toFixed(6);
        document.getElementById('latitudeInput').value = lat.toFixed(6);
        document.getElementById('longitudeInput').value = lon.toFixed(6);
    }

    let dragInteraction = new ol.interaction.Translate({
        features: new ol.Collection([markerFeature])
    });
    map.addInteraction(dragInteraction);

    dragInteraction.on('translating', function(event) {
        const coordinates = event.target.getFeatures().getArray()[0].getGeometry().getCoordinates();
        const lonLat = ol.proj.toLonLat(coordinates);
        updateInputs(lonLat[0], lonLat[1]);
    });

    map.on('singleclick', function (event) {
        const coordinates = ol.proj.toLonLat(event.coordinate);
        const [lon, lat] = coordinates;

        markerSource.clear();
        const newMarkerFeature = new ol.Feature({
            geometry: new ol.geom.Point(event.coordinate)
        });
        newMarkerFeature.setStyle(markerStyle);
        markerSource.addFeature(newMarkerFeature);

        updateInputs(lon, lat);
    });

    document.getElementById('searchButton').addEventListener('click', function() {
        const query = document.getElementById('searchInput').value;
        if (query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data[0]) {
                        const lon = parseFloat(data[0].lon);
                        const lat = parseFloat(data[0].lat);
                        const coordinates = ol.proj.fromLonLat([lon, lat]);

                        markerSource.clear();
                        const newMarkerFeature = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates)
                        });
                        newMarkerFeature.setStyle(markerStyle);
                        markerSource.addFeature(newMarkerFeature);

                        map.getView().setCenter(coordinates);
                        map.getView().setZoom(13);

                        updateInputs(lon, lat);
                    } else {
                        alert('Location not found');
                    }
                })
                .catch(error => console.error('Error fetching location:', error));
        }
    });
    updateInputs(100.5018, 13.7563);
</script>
{% endblock %}
