{% extends 'base.html' %}
{% block content %}
    <div class="container mx-auto px-4">
        <!-- Stepper -->
        <div class="mb-5 flex justify-center">
            <ul class="steps steps-horizontal w-full max-w-2xl">
                <li class="step step-primary">Queue Setup</li>
                <li class="step step-primary">Hours & Location</li>
                <li class="step">Add Resources</li>
            </ul>
        </div>

        <!-- Main Card -->
        <div class="card bg-base-100 border-2 border-base-200 max-w-4xl mx-auto">
            <div class="card-body">
                <h2 class="card-title text-2xl font-bold">Set Hours & Location</h2>

                <form method="post" id="queueForm" class="">
                    {% csrf_token %}
                        <div class="flex flex-col sm:flex-row justify-start gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Opening Time</span>
                                </label>
                                {{ form.open_time }}
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Closing Time</span>
                                </label>
                                {{ form.close_time }}
                            </div>
                        </div>
                    <!-- Location Section -->
                        <h3 class="text-lg font-semibold mb-2 mt-3">Location Details</h3>

                        <!-- Search Box -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text font-medium">Search Location</span>
                            </label>
                            <div class="input-group">
                                <input type="text"
                                       id="searchInput"
                                       class="input input-bordered flex-1"
                                       placeholder="Enter location to search">
                                <button type="button" id="useLocationButton"
                                    class="items-center p-2 bg-transparent border-2 border-blue-500 rounded-full hover:bg-blue-100 inline-flex ml-2">
                                <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Use My Location"
                                     class="w-5 h-5 mr-2 cursor-pointer"/>
                                <span class="text-blue-500 font-medium">Your location</span>
                            </button>
                            </div>

                        <!-- Coordinates Input -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Latitude</span>
                                </label>
                                <input type="number"
                                       id="latitudeInput"
                                       class="input input-bordered w-full"
                                       placeholder="Latitude"
                                       step="any">
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Longitude</span>
                                </label>
                                <input type="number"
                                       id="longitudeInput"
                                       class="input input-bordered w-full"
                                       placeholder="Longitude"
                                       step="any">
                            </div>
                        </div>

                        <!-- Map -->
                        <div class="rounded-box overflow-hidden border border-base-300">
                            <div id="map" class="w-full" style="height: 400px;"></div>
                        </div>
                    </div>

                    <!-- Hidden Inputs -->
                    <input type="hidden" name="latitude" id="id_latitude" required>
                    <input type="hidden" name="longitude" id="id_longitude" required>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between items-center pt-4">
                        <a href="{% url 'manager:create_queue_step' step='1' %}" class="btn btn-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd"
                                      d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Previous
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Next
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd"
                                      d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                                      clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css"/>
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>

    <script>
        // Keep all the existing JavaScript code exactly the same
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([100.5018, 13.7563]),
                zoom: 13
            })
        });

        const markerStyle = new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                src: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                scale: 0.08
            })
        });

        const markerSource = new ol.source.Vector();
        const markerLayer = new ol.layer.Vector({
            source: markerSource,
            style: markerStyle
        });
        map.addLayer(markerLayer);

        let markerFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([100.5018, 13.7563]))
        });
        markerSource.addFeature(markerFeature);

        function updateInputs(lon, lat) {
            document.getElementById('id_latitude').value = lat?.toFixed(6) || '';
            document.getElementById('id_longitude').value = lon?.toFixed(6) || '';
            document.getElementById('latitudeInput').value = lat?.toFixed(6) || '';
            document.getElementById('longitudeInput').value = lon?.toFixed(6) || '';
        }

        const modifyInteraction = new ol.interaction.Modify({
            source: markerSource,
            hitDetection: markerLayer,
        });
        map.addInteraction(modifyInteraction);

        modifyInteraction.on('modifyend', function (event) {
            if (event.features.getLength() > 0) {
                const feature = event.features.item(0);
                const coordinates = ol.proj.toLonLat(feature.getGeometry().getCoordinates());
                updateInputs(coordinates[0], coordinates[1]);
            }
        });

        map.on('singleclick', function (event) {
            const coordinates = ol.proj.toLonLat(event.coordinate);
            const [lon, lat] = coordinates;

            markerSource.clear();
            const newMarkerFeature = new ol.Feature({
                geometry: new ol.geom.Point(event.coordinate)
            });
            markerSource.addFeature(newMarkerFeature);

            updateInputs(lon, lat);
        });

        document.getElementById('useLocationButton').addEventListener('click', function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    console.log(`User location: Lat = ${lat}, Lon = ${lon}`);

                    const coordinates = ol.proj.fromLonLat([lon, lat]);
                    map.getView().setCenter(coordinates);
                    map.getView().setZoom(13);

                    markerSource.clear();
                    const newMarkerFeature = new ol.Feature({
                        geometry: new ol.geom.Point(coordinates)
                    });
                    markerSource.addFeature(newMarkerFeature);
                    updateInputs(lon, lat);
                }, function () {
                    alert("Error: The Geolocation service failed.");
                });
            } else {
                alert("Error: Your browser does not support geolocation.");
            }
        });

        document.getElementById('searchButton').addEventListener('click', searchLocation);
        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchLocation();
            }
        });

        function searchLocation() {
            var query = document.getElementById('searchInput').value.trim();

            if (!query) {
                alert("Please enter a location to search.");
                return;
            }

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = parseFloat(data[0].lat);
                        var lon = parseFloat(data[0].lon);
                        const coordinates = ol.proj.fromLonLat([lon, lat]);
                        map.getView().setCenter(coordinates);
                        map.getView().setZoom(13);
                        markerSource.clear();
                        let newMarkerFeature = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates)
                        });
                        markerSource.addFeature(newMarkerFeature);
                        updateInputs(lon, lat);
                    } else {
                        alert("Location not found. Please try again.");
                    }
                })
                .catch(error => {
                    console.error("Error searching location:", error);
                    alert("Unable to search location. Please try again later.");
                });
        }

        document.getElementById('queueForm').addEventListener('submit', function (event) {
            const latitude = document.getElementById('id_latitude').value;
            const longitude = document.getElementById('id_longitude').value;

            if (!latitude || !longitude) {
                event.preventDefault();
                alert('Please select a location on the map before proceeding.');
            }
        });

        updateInputs(null, null);
    </script>
{% endblock %}