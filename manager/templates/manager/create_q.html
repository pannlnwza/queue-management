{% extends 'base.html' %}

{% block content %}
<main>
    <div class="card bg-base-200/70 text-base-content w-full sm:w-3/4 md:w-1/2 mx-auto p-6">
        <h2 class="card-title mb-4 text-center">Create a New Queue</h2>
        <form method="POST" enctype="multipart/form-data" id="queueForm">
            {% csrf_token %}

            <div class="form-group mb-4">
                <label for="{{ form.name.id_for_label }}">Queue Name</label>
                <div>{{ form.name }}</div>
            </div>

            <div class="form-group mb-4">
                <label for="{{ form.description.id_for_label }}">Description</label>
                <div>{{ form.description }}</div>
            </div>

            <div class="form-group mb-4">
                <label for="{{ form.category.id_for_label }}">Category</label>
                <div>{{ form.category }}</div>
            </div>

            <div class="form-group mb-4">
                <label for="{{ form.logo.id_for_label }}">Logo (Optional)</label>
                <div>{{ form.logo }}</div>
            </div>

            <div class="form-group mb-4">
                <label for="searchInput">Search for Queue Location</label>
                <div class="flex items-center gap-2">
                    <input type="text" id="searchInput" class="input input-bordered w-full mt-3"
                           placeholder="Enter location to search">
                    <button type="button" id="searchButton" class="btn btn-primary mt-3">
                        Search
                    </button>
                </div>
            </div>

            <div class="form-group mb-4">
                <label>Mark your queue location by dragging the blue marker</label>
                <div id="map" class="mt-4" style="height: 400px;"></div>
            </div>

            <input type="hidden" name="latitude" id="id_latitude" required>
            <input type="hidden" name="longitude" id="id_longitude" required>

            <button type="submit" class="btn btn-primary w-full mt-4">Create Queue</button>
        </form>
    </div>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([13.7563, 100.5018], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var marker = L.marker([13.7563, 100.5018], { draggable: true }).addTo(map);

    marker.on('dragend', function () {
        var lat = marker.getLatLng().lat;
        var lng = marker.getLatLng().lng;
        document.getElementById('id_latitude').value = lat;
        document.getElementById('id_longitude').value = lng;
    });

    document.getElementById('searchButton').addEventListener('click', function () {
        searchLocation();
    });

    document.getElementById('searchInput').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent form submission
            searchLocation();
        }
    });

    function searchLocation() {
        var query = document.getElementById('searchInput').value.trim();

        if (!query) {
            alert("Please enter a location to search.");
            return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lon = parseFloat(data[0].lon);

                    map.setView([lat, lon], 13);
                    marker.setLatLng([lat, lon]);
                    document.getElementById('id_latitude').value = lat;
                    document.getElementById('id_longitude').value = lon;
                } else {
                    alert("Location not found. Please try again.");
                }
            })
            .catch(error => {
                console.error("Error searching location:", error);
                alert("Unable to search location. Please try again later.");
            });
    }

    document.getElementById('queueForm').addEventListener('submit', function (event) {
        var latitude = document.getElementById('id_latitude').value;
        var longitude = document.getElementById('id_longitude').value;

        if (!latitude || !longitude) {
            event.preventDefault();
            document.getElementById('locationError').style.display = 'block';
        } else {
            document.getElementById('locationError').style.display = 'none';
        }
    });
</script>
{% endblock %}
